
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>PHP Class Design for MySQL? - Ting Wai's Blog</title>
  <meta name="author" content="Chong Ting Wai">

  
  <meta name="description" content="Since I first started out my journey on PHP, I have been trying to find a good design to make coding less messy when using MySQL.
Anyone use PHP &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ctingwai.github.com/blog/2013/10/09/php-class-design-for-mysql">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ting Wai's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41040867-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ting Wai's Blog</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ctingwai.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">PHP Class Design for MySQL?</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-09T15:24:00+08:00" pubdate data-updated="true">Oct 9<span>th</span>, 2013</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Since I first started out my journey on PHP, I have been trying to find a good design to make coding less messy when using MySQL.
Anyone use PHP knows that mixing PHP and MySQL together makes the code less readable and less modifiable, worse, it makes debugging
much harder. These situations would only get worse if you don&#8217;t refactor your code. So, here is my solution for PHP (sure, it is
applicable in any language), using an abstract class as the base class for all records:</p>

<!-- more -->




<figure class='code'><figcaption><span>Record </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
<span class='line-number'>457</span>
<span class='line-number'>458</span>
<span class='line-number'>459</span>
<span class='line-number'>460</span>
<span class='line-number'>461</span>
<span class='line-number'>462</span>
<span class='line-number'>463</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?php
</span><span class='line'>abstract class Record{
</span><span class='line'>    //The tables where the operation will take place
</span><span class='line'>    const UPDATE_TABLE = 0; //The table where the record to be updated
</span><span class='line'>    const DELETE_TABLE = 1; //The table where the record to be deleted
</span><span class='line'>
</span><span class='line'>    //Operations against the table/s
</span><span class='line'>    const OP_DELETE = 'delete_record';
</span><span class='line'>    const OP_UPDATE = 'update_record';
</span><span class='line'>    const OP_CREATE = 'create_record';
</span><span class='line'>    const OP_READ = 'read_record';
</span><span class='line'>
</span><span class='line'>    //For type checking
</span><span class='line'>    const TYPE_STRING = 'string';
</span><span class='line'>    const TYPE_BOOL = 'boolean';
</span><span class='line'>    const TYPE_INT = 'integer';
</span><span class='line'>    const TYPE_DOUBLE = 'double';
</span><span class='line'>    const TYPE_ARRAY = 'array';
</span><span class='line'>    const TYPE_OBJECT = 'object';
</span><span class='line'>    const TYPE_RESOURCE = 'resource';
</span><span class='line'>    const TYPE_NULL = 'NULL';
</span><span class='line'>    const TYPE_UNKNOWN = 'unknown type';
</span><span class='line'>
</span><span class='line'>    //Log types for log4php
</span><span class='line'>    const LOG_TYPE_WARN = "WARN";
</span><span class='line'>    const LOG_TYPE_INFO = "INFO";
</span><span class='line'>    const LOG_TYPE_DEBUG = "DEBUG";
</span><span class='line'>
</span><span class='line'>    const ID = 'id';
</span><span class='line'>    
</span><span class='line'>    protected $logger;
</span><span class='line'>    protected $connection;
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Constructor
</span><span class='line'>     * @param connection MySQLi object used to connect to MySQL database
</span><span class='line'>     * @param hostname The hostname of the server
</span><span class='line'>     * @param username The username to connect to MySQL
</span><span class='line'>     * @param passwd The password to connect to MySQL
</span><span class='line'>     * @param dbname The database name of MySQL to use
</span><span class='line'>     */
</span><span class='line'>    function __construct(mysqli $connection = null,
</span><span class='line'>                         $hostname = "localhost",
</span><span class='line'>                         $username = "root",
</span><span class='line'>                         $passwd = "",
</span><span class='line'>                         $dbname = "purchase_order"){
</span><span class='line'>        if($connection === null)
</span><span class='line'>            $this->connection = new mysqli($hostname, $username,
</span><span class='line'>                                           $passwd, $dbname);
</span><span class='line'>        else
</span><span class='line'>            $this->connection = $connection;
</span><span class='line'>
</span><span class='line'>        $this->connection->set_charset('utf8');
</span><span class='line'>
</span><span class='line'>        $this->logger = null;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Set the logger for log4php
</span><span class='line'>     * @param logger The logger used for loggin
</span><span class='line'>     */
</span><span class='line'>    function setLogger($logger = null){
</span><span class='line'>        $this->logger = $logger;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Get the connection for the database
</span><span class='line'>     */
</span><span class='line'>    public function getConnection(){
</span><span class='line'>        return $this->connection;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Get the connection error description
</span><span class='line'>     * @return The error for the connection
</span><span class='line'>     */
</span><span class='line'>    public function error(){
</span><span class='line'>        return $this->connection->error;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /************************************
</span><span class='line'>     *RETRIEVE
</span><span class='line'>     ************************************/
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Custom query without escapes, escape your values before passing into
</span><span class='line'>     * this function
</span><span class='line'>     * @param fields MySQL fields comma separated
</span><span class='line'>     * @param tbl MySQL table comma separated
</span><span class='line'>     * @param condition Full MySQL conditions without 'WHERE' keyword
</span><span class='line'>     f @param additional An additional MySQL queries, have to be in MySQL
</span><span class='line'>     * @return Associative array of results or null on failure
</span><span class='line'>     */
</span><span class='line'>    public function select($fields = null, $tbl = null, $condition = null,
</span><span class='line'>                           $additional = null){
</span><span class='line'>        if(!$this->isValidValues(array($fields, $tbl), self::TYPE_STRING))
</span><span class='line'>            return null;
</span><span class='line'>
</span><span class='line'>        $sql = "SELECT $fields FROM $tbl";
</span><span class='line'>
</span><span class='line'>        $authCond = null;
</span><span class='line'>        $auth = $this->isAuthorized(self::OP_READ, $authCond);
</span><span class='line'>        if(!$auth){
</span><span class='line'>            $this->log('Unauthorized read access!', self::LOG_TYPE_WARN);
</span><span class='line'>            return null;
</span><span class='line'>        }else if($auth && $authCond != null)
</span><span class='line'>            $sql .= " WHERE $authCond";
</span><span class='line'>
</span><span class='line'>        if($condition != null){
</span><span class='line'>            if($authCond != null)
</span><span class='line'>                $sql .= " AND $condition $additional";
</span><span class='line'>            else
</span><span class='line'>                $sql .= " WHERE $condition $additional";
</span><span class='line'>        }else
</span><span class='line'>            $sql .= " $additional";
</span><span class='line'>        $this->log("Executing SQL: $sql", self::LOG_TYPE_DEBUG);
</span><span class='line'>
</span><span class='line'>        $query = $this->connection->query($sql);
</span><span class='line'>        if($query){
</span><span class='line'>            $result = $this->fetchAllAssoc($query);
</span><span class='line'>            $query->close();
</span><span class='line'>            $this->log("Query success: Fetched ". count($result)."rows",
</span><span class='line'>                        self::LOG_TYPE_DEBUG);
</span><span class='line'>
</span><span class='line'>            return $result;
</span><span class='line'>        }else
</span><span class='line'>            $this->log("Query failed: ". $this->error(), self::LOG_TYPE_WARN);
</span><span class='line'>
</span><span class='line'>        return null;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Get all records with starting records and number of records
</span><span class='line'>     * @param start The starting record, default 0
</span><span class='line'>     * @param count The number of records, set to 0 to list all, default 0
</span><span class='line'>     * @return An associative array based on field name as keys or null on
</span><span class='line'>     * failure
</span><span class='line'>     */
</span><span class='line'>    public function getAll($start = 0, $count = 0){
</span><span class='line'>        $this->log('Retrieving all records', self::LOG_TYPE_INFO);
</span><span class='line'>        $fields = null;
</span><span class='line'>        $tables = null;
</span><span class='line'>        $conditions = null;
</span><span class='line'>
</span><span class='line'>        $this->getAllQueryStatements($fields, $tables, $conditions);
</span><span class='line'>
</span><span class='line'>        if(!$this->isValidValues(array($fields, $tables), self::TYPE_STRING))
</span><span class='line'>            return null;
</span><span class='line'>
</span><span class='line'>        if($count != 0)
</span><span class='line'>            return $this->select($fields, $tables, $conditions, "LIMIT $start,
</span><span class='line'>                                 $count");
</span><span class='line'>        else
</span><span class='line'>            return $this->select($fields, $tables, $conditions);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /************************************
</span><span class='line'>     *CREATE
</span><span class='line'>     ************************************/
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Insert a record
</span><span class='line'>     * @param fields The fields to be inserted
</span><span class='line'>     * @return True on success, null on failure
</span><span class='line'>     */
</span><span class='line'>    public function insert(array $fields = null){}
</span><span class='line'>
</span><span class='line'>    /************************************
</span><span class='line'>     *UPDATE
</span><span class='line'>     ************************************/
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Updates a record, using template method.
</span><span class='line'>     * At least the 'id' key has to be set.
</span><span class='line'>     * @param fields The field/s to be updated
</span><span class='line'>     * @see subclass::getUpdateColumns()
</span><span class='line'>     */
</span><span class='line'>    public function update(array $fields = null){
</span><span class='line'>        $this->log('Updating record', self::LOG_TYPE_INFO);
</span><span class='line'>
</span><span class='line'>        //Authorization
</span><span class='line'>        $authCond = null;
</span><span class='line'>        if(!$this->isAuthorized(self::OP_UPDATE, $authCond)){
</span><span class='line'>            $this->log('Unauthorized update!', self::LOG_TYPE_WARN);
</span><span class='line'>            return null;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        $table = $this->getTableName(self::UPDATE_TABLE);
</span><span class='line'>        $columns = $this->getUpdateColumns($fields, $table);
</span><span class='line'>
</span><span class='line'>        if($fields === null || !$this->validKeys(array(self::ID), $fields))
</span><span class='line'>            return null;
</span><span class='line'>
</span><span class='line'>        $this->preUpdate($fields[self::ID]);
</span><span class='line'>
</span><span class='line'>        $result = null;
</span><span class='line'>        if($table && count($columns) > 0){
</span><span class='line'>            $sql = "UPDATE " . $table . " SET ";
</span><span class='line'>            $count = count($columns);
</span><span class='line'>            if(isset($columns['conditions']))
</span><span class='line'>                $count = count($columns) - 1;
</span><span class='line'>            for($i = 0; $i &lt; $count; $i++){
</span><span class='line'>                $sql .= $columns[$i];
</span><span class='line'>                if($i &lt; $count -1)
</span><span class='line'>                    $sql .= ", "; //Insert comma if not last element
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>            if(!isset($columns['conditions']))
</span><span class='line'>                $sql .= " WHERE id=" . $fields[self::ID];
</span><span class='line'>            else
</span><span class='line'>                $sql .= ' WHERE '. $columns['conditions'];
</span><span class='line'>
</span><span class='line'>            if($authCond != null)
</span><span class='line'>                $sql .= " AND $authCond";
</span><span class='line'>
</span><span class='line'>            $this->log("Executing SQL: $sql", self::LOG_TYPE_DEBUG);
</span><span class='line'>
</span><span class='line'>            $result = $this->connection->query($sql);
</span><span class='line'>            if(!$result){
</span><span class='line'>                $this->log("SQL statement failed: ". $this->error(),
</span><span class='line'>                                    self::LOG_TYPE_WARN);
</span><span class='line'>                $result = null;
</span><span class='line'>            }else{
</span><span class='line'>                $this->log('SQL execution successful!',
</span><span class='line'>                            self::LOG_TYPE_INFO);
</span><span class='line'>                $result = $fields['id'];
</span><span class='line'>            }
</span><span class='line'>        }else if($table === '' || $table === null){
</span><span class='line'>            $this->log('Invalid table name for update!',
</span><span class='line'>                        self::LOG_TYPE_WARN);
</span><span class='line'>            $result = null;
</span><span class='line'>        }else if(count($columns) &lt;= 0){
</span><span class='line'>            $this->log('No columns returned!', self::LOG_TYPE_WARN);
</span><span class='line'>            $result = null;
</span><span class='line'>        }else
</span><span class='line'>            $this->log('An unknown mutant error has occured! Arghh!!',
</span><span class='line'>                        self::LOG_TYPE_WARN);
</span><span class='line'>
</span><span class='line'>        $this->postUpdate($result);
</span><span class='line'>        return $result;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /************************************
</span><span class='line'>     *DELETE
</span><span class='line'>     ************************************/
</span><span class='line'>    /**
</span><span class='line'>     * Delete a record
</span><span class='line'>     * @param id The id that identifies the record to be deleted
</span><span class='line'>     * @return Deleted ID on success null on failure
</span><span class='line'>     */
</span><span class='line'>    public function delete($id = null){
</span><span class='line'>        if(!$this->isValidValues(array($id), self::TYPE_INT))
</span><span class='line'>            return null;
</span><span class='line'>
</span><span class='line'>        $this->log("Deleting record $id", self::LOG_TYPE_INFO);
</span><span class='line'>
</span><span class='line'>        $data = null;
</span><span class='line'>        $this->preDelete($id);
</span><span class='line'>
</span><span class='line'>        //Authorization
</span><span class='line'>        $authCond = null;
</span><span class='line'>        if(!$this->isAuthorized(self::OP_UPDATE, $authCond)){
</span><span class='line'>            $this->log('Unauthorized update!', self::LOG_TYPE_WARN);
</span><span class='line'>            return null;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        $sql = "DELETE FROM " . $this->getTableName(self::DELETE_TABLE)
</span><span class='line'>             . " WHERE id=$id";
</span><span class='line'>        $this->log("Executing SQL: $sql", self::LOG_TYPE_DEBUG);
</span><span class='line'>        $result = $this->connection->query($sql);
</span><span class='line'>        if(!$result){
</span><span class='line'>            $this->log("SQL statement failed: ". $this->error(),
</span><span class='line'>                        self::LOG_TYPE_WARN);
</span><span class='line'>            $result = null;
</span><span class='line'>        }else
</span><span class='line'>            $result = $id;
</span><span class='line'>
</span><span class='line'>        $this->postDelete($result);
</span><span class='line'>
</span><span class='line'>        return $result;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /************************************
</span><span class='line'>     *TEMPLATE METHOD
</span><span class='line'>     ************************************/
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Template method for getAll() function
</span><span class='line'>     * Modify fields, tables and conditions to suit your need
</span><span class='line'>     * @param fields The fields that need to be modified
</span><span class='line'>     * @param tables The tables that need to be modified
</span><span class='line'>     * @param conditions The conditions that need to be modified (optional)
</span><span class='line'>     */
</span><span class='line'>    abstract protected function getAllQueryStatements(&$fields, &$tables,
</span><span class='line'>                                                      &$conditions);
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Template method for update() function
</span><span class='line'>     * If 'conditions' key is set, it will override the original WHERE clause
</span><span class='line'>     * @return array An array of individual 'field'='value' string for SET
</span><span class='line'>     * MySQL clause
</span><span class='line'>     * @see Record::update()
</span><span class='line'>     */
</span><span class='line'>    protected function getUpdateColumns(array &$fields = null){}
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Template method for delete() and update() to get the table name to be
</span><span class='line'>     * altered
</span><span class='line'>     */
</span><span class='line'>    abstract protected function getTableName($operation);
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Operations before the deletion of a record
</span><span class='line'>     * @param id The id of the record to be deleted
</span><span class='line'>     */
</span><span class='line'>    protected function preDelete($id){}
</span><span class='line'>    /**
</span><span class='line'>     * Operations after the deletion of a record
</span><span class='line'>     * @param result True on success null on failure
</span><span class='line'>     */
</span><span class='line'>    protected function postDelete($result){}
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Operations before the update process
</span><span class='line'>     * @param id The id of the record to be deleted
</span><span class='line'>     */
</span><span class='line'>    protected function preUpdate($id){}
</span><span class='line'>    /**
</span><span class='line'>     * Operations after the update process
</span><span class='line'>     * @param result True on success null on failure
</span><span class='line'>     */
</span><span class='line'>    protected function postUpdate($result){}
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Whether an operation against a record is authorized
</span><span class='line'>     */
</span><span class='line'>    protected function isAuthorized($operation = null, &$condition = null){
</span><span class='line'>        return true;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /************************************
</span><span class='line'>     *HANDY UTILITIES
</span><span class='line'>     ************************************/
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Converts 2D array to 1D array
</span><span class='line'>     * @param array The array to convert
</span><span class='line'>     * @return A converted 1D array or null on failure
</span><span class='line'>     */
</span><span class='line'>    public function toSingleArray(array $array = null){
</span><span class='line'>        $this->log('Converting 2D '. count($array) .' to 1D array',
</span><span class='line'>                    self::LOG_TYPE_INFO);
</span><span class='line'>        if($array === null || count($array) == 0)
</span><span class='line'>            return null;
</span><span class='line'>
</span><span class='line'>        $result = array();
</span><span class='line'>        foreach($array as $row){
</span><span class='line'>            foreach($row as $key => $value)
</span><span class='line'>                $result[$key] = $value;
</span><span class='line'>        }
</span><span class='line'>        $this->log('Conversion resulted in an array size of '. count($result),
</span><span class='line'>                    self::LOG_TYPE_INFO);
</span><span class='line'>
</span><span class='line'>        return $result;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Validate if an array of values contain not allowable values, return false if not
</span><span class='line'>     * @param requiredKeys The keys that are non-empty and non-null
</span><span class='line'>     * @param fields The fields that needed to be checked
</span><span class='line'>     * @return True on success or false on violation
</span><span class='line'>     */
</span><span class='line'>    public function validKeys(array $requiredKeys = null, array $fields = null){
</span><span class='line'>        $this->log('Checking for invalid keys', self::LOG_TYPE_INFO);
</span><span class='line'>        if($fields === null || !$requiredKeys){
</span><span class='line'>            $this->log('Null array found!', self::LOG_TYPE_WARN);
</span><span class='line'>            return false;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        foreach($requiredKeys as $key){
</span><span class='line'>            if(!isset($fields[$key])){
</span><span class='line'>                $this->log('Required field key ('. $key .') not found!',
</span><span class='line'>                            self::LOG_TYPE_WARN);
</span><span class='line'>                return false;
</span><span class='line'>            }
</span><span class='line'>            if($fields[$key] === null){
</span><span class='line'>                $this->log('Null not allowed for key ('. $key .')!',
</span><span class='line'>                            self::LOG_TYPE_WARN);
</span><span class='line'>                return false;
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        return true;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Check if values are valid and the type of the values
</span><span class='line'>     * @param values The values to check against
</span><span class='line'>     * @param datatype Accepted data type for $values
</span><span class='line'>     * @return True on success or false on violation
</span><span class='line'>     */
</span><span class='line'>    public function isValidValues($value = null, $datatype = self::TYPE_STRING){
</span><span class='line'>        $this->log('Checking for invalid values (non-'. $datatype .')',
</span><span class='line'>                    self::LOG_TYPE_INFO);
</span><span class='line'>        if($value === null){
</span><span class='line'>            $this->log('Null array found! $values can\'t be null!',
</span><span class='line'>                        self::LOG_TYPE_WARN);
</span><span class='line'>            return false;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        if(gettype($value) == self::TYPE_ARRAY){
</span><span class='line'>            foreach($value as $val){
</span><span class='line'>                if($val === null || gettype($val) != $datatype){
</span><span class='line'>                    if(gettype($val) == self::TYPE_ARRAY)
</span><span class='line'>                        $val = implode(', ', $val);
</span><span class='line'>                    $this->log('Invalid values found => "'. $val
</span><span class='line'>                              .'" of type "'. gettype($val) .'"',
</span><span class='line'>                                self::LOG_TYPE_WARN);
</span><span class='line'>                    return false;
</span><span class='line'>                }
</span><span class='line'>            }
</span><span class='line'>        }else{
</span><span class='line'>            if($value === null || gettype($value) != $datatype){
</span><span class='line'>                $this->log('Invalid values found => "'. $value
</span><span class='line'>                          .'" of type "'. gettype($value) .'"',
</span><span class='line'>                            self::LOG_TYPE_WARN);
</span><span class='line'>                return false;
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        return true;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Write to log file
</span><span class='line'>     * @param msg The message to write
</span><span class='line'>     * @param type The type of log
</span><span class='line'>     */
</span><span class='line'>    protected function log($msg = "", $type = self::LOG_TYPE_INFO){
</span><span class='line'>        if($this->logger != null){
</span><span class='line'>            if($type == self::LOG_TYPE_WARN){
</span><span class='line'>                $this->logger->warn($msg);
</span><span class='line'>            }else if($type == self::LOG_TYPE_INFO){
</span><span class='line'>                $this->logger->info($msg);
</span><span class='line'>            }else if($type == self::LOG_TYPE_DEBUG){
</span><span class='line'>                $this->logger->debug($msg);
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    public function fetchAllAssoc($result = null){
</span><span class='line'>        if($result === null)
</span><span class='line'>            return null;
</span><span class='line'>
</span><span class='line'>        $assoc = array();
</span><span class='line'>        while($row = $result->fetch_assoc()){
</span><span class='line'>            $assoc[] = $row;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        return $assoc;
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>?></span></code></pre></td></tr></table></div></figure>


<p>The design that here make heavy use of IDs in the table. So, you might need to tailor it to suit your needs.
After creating this class, you can start using it as the base class for all your other database operations. Just extend it
like you would with other classes, and start implementing classes in the blocks marked <strong>TEMPLATE METHOD</strong>, abstract
functions are mandatory which you must implement, while non-abstract functions are optional, they are there just so you don&#8217;t
need to implement what you don&#8217;t use. A sample of a derived class would look like this:</p>

<figure class='code'><figcaption><span>Sample Implementation </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?php
</span><span class='line'>require_once('Record.php');
</span><span class='line'>/**
</span><span class='line'> * This class will handle all the item records in the item table
</span><span class='line'> */
</span><span class='line'>class ItemRecord extends Record{
</span><span class='line'>
</span><span class='line'>    /************************************
</span><span class='line'>     *CREATE
</span><span class='line'>     ************************************/
</span><span class='line'>    /**
</span><span class='line'>     * $fields should have all the following keys except 'description':
</span><span class='line'>     * - ITEM_NO: The item number (string)
</span><span class='line'>     * - ITEM_DESC: Description of the item (string)
</span><span class='line'>     * - ITEM_QTY: Quantity of the item (integer)
</span><span class='line'>     * - ITEM_PRICE: Price of the item (float or double)
</span><span class='line'>     * {@inheritdoc}
</span><span class='line'>     */
</span><span class='line'>    public function insert(array $fields = null){
</span><span class='line'>        if(!$this->validKeys(array(self::ITEM_NO, self::ITEM_QTY, self::ITEM_PRICE), $fields))
</span><span class='line'>            return null;
</span><span class='line'>        if(!$this->isValidInput($fields))
</span><span class='line'>            return null;
</span><span class='line'>
</span><span class='line'>        $this->log('Inserting record', self::LOG_TYPE_INFO);
</span><span class='line'>
</span><span class='line'>        $insertFields = 'item_no, quantity , price, item_description';
</span><span class='line'>            
</span><span class='line'>        $values = "'". $this->connection->escape_string($fields[self::ITEM_NO])
</span><span class='line'>            . "', ". $fields[self::ITEM_QTY] .', '. $fields[self::ITEM_PRICE] .', ';
</span><span class='line'>        if(isset($fields[self::ITEM_DESC]))
</span><span class='line'>            $values .= "'". $this->connection->escape_string($fields[self::ITEM_DESC]) ."'";
</span><span class='line'>        else
</span><span class='line'>            $values .= "null";
</span><span class='line'>
</span><span class='line'>        $sql = "INSERT INTO ". self::ITEM_TABLE ." ($insertFields) VALUES ($values)" ;
</span><span class='line'>
</span><span class='line'>        $this->log("Executing SQL: $sql", self::LOG_TYPE_DEBUG);
</span><span class='line'>
</span><span class='line'>        if($this->connection->query($sql))
</span><span class='line'>            return $this->connection->insert_id;
</span><span class='line'>
</span><span class='line'>        $this->log("SQL execution failed: ". $this->error(),
</span><span class='line'>                    self::LOG_TYPE_WARN);
</span><span class='line'>        return null;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /************************************
</span><span class='line'>     *TEMPLATE METHOD IMPLEMENTATION
</span><span class='line'>     ************************************/
</span><span class='line'>    /**
</span><span class='line'>     * {@inheritDoc}
</span><span class='line'>     */
</span><span class='line'>    protected function getTableName($operation){
</span><span class='line'>        return self::ITEM_TABLE;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * {@inheritDoc}
</span><span class='line'>     */
</span><span class='line'>    public function getAllQueryStatements(&$fields, &$tables, &$conditions){
</span><span class='line'>        $fields = '*';
</span><span class='line'>        $tables = self::ITEM_TABLE;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * $fields may have the following keys:
</span><span class='line'>     * - ITEM_NO: The item number
</span><span class='line'>     * - ITEM_DESC: Description of the item
</span><span class='line'>     * - ITEM_QTY: Quantity of the item
</span><span class='line'>     * - ITEM_PRICE: Price of the item
</span><span class='line'>     * {@inheritDoc}
</span><span class='line'>     */
</span><span class='line'>    public function getUpdateColumns(array &$fields = null){
</span><span class='line'>        $columns = array();
</span><span class='line'>
</span><span class='line'>        if(!$this->isValidInput($fields)){
</span><span class='line'>            $this->log('Incorrect data type detected!', self::LOG_TYPE_WARN);
</span><span class='line'>            return null;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        if(isset($fields[self::ITEM_NO]))
</span><span class='line'>            $columns[] = "item_no='" . $this->connection->escape_string($fields[self::ITEM_NO]) . "'";
</span><span class='line'>        if(isset($fields[self::ITEM_DESC]))
</span><span class='line'>            $columns[] = "item_description='" . $this->connection->escape_string($fields[self::ITEM_DESC]) . "'";
</span><span class='line'>        if(isset($fields[self::ITEM_QTY]))
</span><span class='line'>            $columns[] = "quantity=" . $fields[self::ITEM_QTY];
</span><span class='line'>        if(isset($fields[self::ITEM_PRICE]))
</span><span class='line'>            $columns[] = "price=" . $fields[self::ITEM_PRICE];
</span><span class='line'>
</span><span class='line'>        return $columns;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /************************************
</span><span class='line'>     *UTILITIES
</span><span class='line'>     ************************************/
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * Checks whether input is valid
</span><span class='line'>     * @param fields Array of key value pair to check against
</span><span class='line'>     * @return True if valid or false if invalid
</span><span class='line'>     */
</span><span class='line'>    public function isValidInput($fields = null){
</span><span class='line'>        if((isset($fields[self::ITEM_NO]) && !$this->isValidValues(array($fields[self::ITEM_NO]), self::TYPE_STRING))
</span><span class='line'>        || (isset($fields[self::ITEM_DESC]) && !$this->isValidValues(array($fields[self::ITEM_DESC]), self::TYPE_STRING))
</span><span class='line'>        || (isset($fields[self::ITEM_QTY]) && !$this->isValidValues(array($fields[self::ITEM_QTY]), self::TYPE_INT))
</span><span class='line'>        || (isset($fields[self::ITEM_PRICE]) && !$this->isValidValues(array($fields[self::ITEM_PRICE]), self::TYPE_DOUBLE)))
</span><span class='line'>            return false;
</span><span class='line'>
</span><span class='line'>        return true;
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>?></span></code></pre></td></tr></table></div></figure>


<h2>Usage Notes</h2>

<ol>
<li>Inserting data into table has to be manually implemented with the insert() function.</li>
<li>The getTableName() function <strong>MUST</strong> be implemented, and has to return the table name, the parent class wouldn&#8217;t know if you don&#8217;t tell them which table to update/delete/retrieve/update.</li>
<li>All classes extending <code>Record</code> will automatically have a delete() function without the need for implementation, it uses ID to identify a row in the table, override this function if you don&#8217;t use ID.</li>
<li>Retrieval of records are implemented in getAll() function, which in turn calls getAllQueryStatements() function, you have to set the fields, tables and conditions in this function, no need for return (it&#8217;s pass by reference).</li>
<li>The update() function will call the getUpdateColumns(), so, you have to override getUpdateColumns() to return queries in an array, each index consist of field=value, this will be passed directly into the queries.</li>
<li>All functions starting with pre and post are functions that will be called before and after an operation, it&#8217;s optional.</li>
<li>isAuthorized() function is for authorization if you need your application to authorize certain user access to information, it returns true by default, which means any user is authorized to access any data. You perform some checks in this function, and decide whether the user is authorized to access the data. The variable, <code>$operation</code> is used to tell you what table operation is performing, whether it&#8217;s delete (OP_DELETE), update (OP_UPDATE), create (OP_CREATE) or read (OP_READ), variable <code>$condition</code> is used to add additional conditions into the queries. Once logic is done, you have to return true to authorize access or false to unauthorize the access.</li>
<li>You can either group multiple related tables (e.g. related by foreign keys) into a class extending Record or you can create a class extending Record for every tables you have in your database. However, I still find it more maintainable by creating each class for each table.</li>
<li>This is <strong>NOT</strong> a perfect design, but it should suit any small - medium projects. For larger projects, I probably would not use PHP, I would use a framework if I really need to. Also, the chosen architecture might not be suitable for this design.</li>
</ol>


<p>With this design, you implement only the parts that differ while maintaining the parts of the code (A.K.A template method, it&#8217;s a design pattern by G.O.F.), which minimizes codes to type. Also, if you want to change something that affects all record operations, you change only the base class, or if you wanted to add some functions for all record operations, you can just add it in the base class and it is available in the derived class. However, there is performance penalty for this design, especially when you create a class for each tables in your database, as always, object creation is expensive. But looking at the benefits it offers, I think it is worth the price.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Chong Ting Wai</span></span>

      








  


<time datetime="2013-10-09T15:24:00+08:00" pubdate data-updated="true">Oct 9<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/mysql/'>MySQL</a>, <a class='category' href='/blog/categories/object-oriented/'>Object Oriented</a>, <a class='category' href='/blog/categories/php/'>PHP</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/10/09/postfix-mail-relays/" title="Previous Post: Postfix mail relays">&laquo; Postfix mail relays</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/02/15/blueproximity-for-kde4/" title="Next Post: Blueproximity for KDE4 Configuration">Blueproximity for KDE4 Configuration &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    
<section class="googleplus">
	<h1>
		<a href=http://my.linkedin.com/pub/chong-ting-wai/23/999/b24/>
			<img src="http://developer.linkedin.com/sites/default/files/LinkedIn_Logo30px.png" />LinkedIn
		</a>
	</h1>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/110745063435175433790?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>


<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/03/19/access-router-web-management-interface-remotely-through-ssh/">Access Router Web Management Interface Remotely Through SSH</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/17/bluetoothd-crash-on-connect/">Bluetoothd crash on connect</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/15/blueproximity-for-kde4/">Blueproximity for KDE4 Configuration</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/09/php-class-design-for-mysql/">PHP Class Design for MySQL?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/09/postfix-mail-relays/">Postfix mail relays</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/22/enable-internet-access-on-raspberry-pi-through-wired-connection/">Enable Internet Access on Raspberry Pi Through Wired Connection</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/16/playing-multiple-tracks-vcd-on-linux/">Playing Multiple Tracks VCD on Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/22/downloading-api-documentation-with-wget/">Downloading API Documentation with WGET</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/18/using-juniper-vpn-on-64-bit-linux/">Using Juniper VPN on 64 bit Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/17/optimizing-linux-power-usage/">Optimizing Linux Power Usage</a>
      </li>
    
  </ul>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Chong Ting Wai -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ctingwai';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://ctingwai.github.com/blog/2013/10/09/php-class-design-for-mysql/';
        var disqus_url = 'http://ctingwai.github.com/blog/2013/10/09/php-class-design-for-mysql/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>







</body>
</html>
